<%namespace name="messages_and_text" file="/dagr/components/messagesAndText.html"/>
<%namespace name="modals" file="/dagr/components/modals.html"/>
<%namespace name="collapse" file="/ce1sus/components/collapse.html"/>

<legend>Flat view</legend>
<script type="text/javascript">
  $(document).ready(function() {
    $('#flatViewTable${event_id}').dataTable( {
      "iDisplayLength": 10,
      "aaSorting": [[ 4, "asc" ]],
    });
  });
</script>

<div style="margin-bottom:35px">
  <table class="table table-striped table-bordered table-hover table-condensed" id="flatViewTable${event_id}">
    <thead>
      <tr>
      <th caria-controls="flatViewTable${event_id}" tabindex="0" role="columnheader" class="sorting">#</th>
      <th caria-controls="flatViewTable${event_id}" tabindex="1" role="columnheader" class="sorting">Object #</th>
      <th caria-controls="flatViewTable${event_id}" tabindex="2" role="columnheader" class="sorting">Object</th>
      <th caria-controls="flatViewTable${event_id}" tabindex="3" role="columnheader" class="sorting">Attribute #</th>
      <th caria-controls="flatViewTable${event_id}" tabindex="4" role="columnheader" class="sorting">Attribute Type</th>
      <th caria-controls="flatViewTable${event_id}" tabindex="5" role="columnheader" class="sorting">Attribute Value</th>
      <th caria-controls="flatViewTable${event_id}" tabindex="6" role="columnheader" class="sorting">IOC</th>
      <th caria-controls="flatViewTable${event_id}" tabindex="7" role="columnheader" class="sorting">Created</th>
      <th caria-controls="flatViewTable${event_id}" tabindex="8" role="columnheader" class="sorting">Options</th>
      </tr>
    </thead>
    <tbody>
    <% counter=0%>
    %for flat_object in flat_objects:
      <%  
      if flat_object[1].ioc == 1:
        iocicon = '<span class="glyphicon glyphicon-screenshot"></span>'
      else:
        iocicon = ''
      if flat_object[1].bit_value.is_shareable:
        shareicon = '<span class="glyphicon glyphicon-ok"></span>'
      else:
        shareicon = '<span class="glyphicon glyphicon-remove"></span>'
      attribute_owner = (user.default_group.identifier == flat_object[1].creator_group.identifier)
      if flat_object[1].bit_value.is_proposal and not flat_object[1].bit_value.is_validated:
        tdstyle = 'style="background-color: yellow;"'
      else:
        tdstyle = ''
        
      attribute_owner = (user.default_group.identifier == flat_object[1].creator_group.identifier)
      %>
      <%counter=counter+1%>
      <tr>
      <td ${tdstyle}><%call expr="messages_and_text.object_to_html(counter, shorten_to=60,use_plain_text=False)"/></td>
      <td><%call expr="messages_and_text.object_to_html(flat_object[0].identifier, shorten_to=60,use_plain_text=False)"/></td>
      <td><%call expr="messages_and_text.object_to_html(flat_object[0].definition.name, shorten_to=60,use_plain_text=False)"/></td>
      
      <td><%call expr="messages_and_text.object_to_html(flat_object[1].identifier, shorten_to=60,use_plain_text=False)"/></td>
      <td><%call expr="messages_and_text.object_to_html(flat_object[1].definition.name, shorten_to=60,use_plain_text=False)"/></td>
      <td><%call expr="messages_and_text.object_to_html(flat_object[1].gui_value, shorten_to=60,use_plain_text=False)"/></td>
      <td style="text-align:center">${iocicon}</td>
      <td><%call expr="messages_and_text.object_to_html(flat_object[1].created, shorten_to=60,use_plain_text=False)"/></td>
      <td style="width: 60px;">
            %for option in flat_object[1].definition.handler.get_ordered_view_options(event_id,flat_object[0].identifier,flat_object[1].identifier):
                <%
                show = option.show_always
                if not show:
                  if option.validation_option:
                    show = owner and flat_object[1].bit_value.is_proposal and not flat_object[1].bit_value.is_validated
                  elif option.owner_option:
                    show = owner
                  elif option.attribute_owner_option:
                    show = attribtue_owner and not flat_object[1].bit_value.is_validated 
                  else:
                    show = False 
                    
                %>
                %if show:
                  %if option.class_name == 'ModalOption':
                    <%call expr="collapse.modalDialog(option, event_id, 'ObjectsFlat','/events/event/objects/flat_objects/{0}'.format(event_id))"/>
                  %elif option.class_name == 'YesNoDialogOption':
                    <%call expr="collapse.yesnoDialog(option, event_id, 'ObjectsFlat','/events/event/objects/flat_objects/{0}'.format(event_id))"/>
                  %else:
                    UdO
                  %endif
                %endif
            %endfor
        </td>
      </tr>
    %endfor
    </tbody>
  </table>
</div> 

<form id="paginatorModalAttributeObjectsStructForm">
    <%call expr="modals.generic_modal(id='paginatorModalAttributeObjectsStruct',title='No Title',content_url=None)">
    </%call>
</form>