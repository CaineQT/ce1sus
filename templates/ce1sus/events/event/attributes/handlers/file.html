# -*- coding: utf-8 -*-

<%namespace name="labeledInput" file="/dagr/components/labeledInput.html"/>
<%namespace name="forms" file="/ce1sus/components/forms.html"/>

%if enabled:
<div class="row">
	<div class="col-xs-3 col-sm-3">
		<div style="padding: 5px; text-align: right">
			<label> Value:</label>
		</div>
	</div>
	<div class="col-xs-9 col-sm-9">
		<form id="fileuploadForm" enctype="multipart/form-data">
		    <input type="hidden" value="${eventID}" name="eventID"/>
			<input class="btn-file btn-default" name="value" type="file" /><br />
			<input class="btn btn-default" id="uploadButtonID" type="button" value="Upload"
				onclick="buttonClick()" />
		</form>
		<div id="progress" class="progress" style="visibility: hidden">
			<div id="bar" class="bar" style="visibility: hidden"></div>
			<div class="percent" style="visibility: hidden">0%</div>
		</div>
		<div id="status"></div>
		
	</div>
	
</div>
<%call expr="forms.bitValueForm(bitValue=None, defaultShareValue=defaultShareValue, enabled=enabled)"/>
<script type="text/javascript">
function buttonClick(){
    var formData = new FormData($('#fileuploadForm')[0]);
    var bar = $('#bar');
    var percent = $('#percent');
    var status = $('#status');
    var cb = $('#definitionID');
    request = $.ajax({
        url: '/events/event/attribute/addFile',  //Server script to process data
        type: 'POST',
        // Form data
        data: formData,
        //Options to tell jQuery not to process data or worry about content-type.
        cache: false,
        contentType: false,
        processData: false,
        beforeSend: function() {
            status.empty();
            var percentVal = '0%';
            $('#definitionID').parent().append(' <input type="hidden" name="definition" value="'+$("#definitionID option:selected").val()+'" >');
            $('#definitionID').prop('disabled', true);
            
            bar.show();
            percent.show();
            status.show();
            
            bar.width(percentVal)
            percent.html(percentVal);
        },
        uploadProgress: function(event, position, total, percentComplete) {
            var percentVal = percentComplete + '%';
            bar.width(percentVal)
            percent.html(percentVal);
        },
        complete: function(xhr) {
            bar.hide();
            percent.hide();
            status.hide();
            status.html(xhr.responseText);
        }
    });
    // callback handler that will be called on success
    request.done(function (responseText, textStatus, XMLHttpRequest){
        if (responseText.match(/^<!--OK--/gi)) {
            file = responseText.match(/\*(.*)\*/);
            $("#editBox").html('<div class="row"><div class="col-xs-3 col-sm-3"><div style="padding: 5px; text-align:right"><label> Value:</label></div></div><div class="col-xs-9 col-sm-9">File Uploaded. Don\'t forget to save.<input id="valueID" name="value" type="hidden" value="'+file[1]+'"/></div></div>');
        } else {
            $("#editBox").html('<div class="alert alert-block alert-danger fade in"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button><h4 class="alert-heading">An unexpected Error occurred!</h4><p>'+responseText+'<input id="valueID" name="value" type="hidden" value=""/></p></div>');
        }
    });

    // callback handler that will be called on failure
    request.fail(function (responseText, textStatus, XMLHttpRequest){
        $("#editBox").html('<div class="alert alert-block alert-danger fade in"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button><h4 class="alert-heading">An unexpected Error occurred!</h4><p>'+responseText+'<input id="valueID" name="value" type="hidden" value=""/></p></div>');
    });
}
</script>
%else:
  <%call expr="labeledInput.genericLabeler('Location',enabled)">
  <div style="padding: 5px;">
    %if canDownload:
        <a href="${url}"  target="_blank">Download</a>
    %else:
        (Not Accessible)
    %endif
  </div>
  </%call>
%endif