<%namespace name="modals" file="/dagr/components/modals.html"/>
<%namespace name="baseForms" file="/dagr/components/forms.html"/> 
<%namespace name="forms" file="/ce1sus/components/forms.html"/> 
<%namespace name="pagination" file="/dagr/components/pagination.html"/>
<%namespace name="objectsHelper" module="dagr.web.helpers.objects"/>

<%def name="objectCollapseItem(id, parentID, eventID, object, paginator, indent=0, showMenu=True, owner=False)">
% if (not object is None) or ((object.bitValue.isValidated and object.bitValue.isSharable) or owner): 
        <div class="panel panel-default" >
        <div class="panel-heading">
            <div class="row">
                <div class="col-xs-7 col-sm-7">
                     <a class="accordion-toggle" data-toggle="collapse" data-parent="#${parentID}" href="#${id}" >
                        ${object.definition.name} - ${object.identifier}
                    </a>
                </div>
                <div class="col-xs-5 col-sm-5" style="text-align: right;">
                    <div class="btn-group">
                    <%
                   
                    if len(object.definition.attributes) == 0:
                      disabledStr = ' disabled" '
                    else:
                      disabledStr = '" data-toggle="modal"'
                    %> 
                    %if showMenu:
                        %if owner:
                       <a href="#addObjectAttributeModal${object.identifier}" role="button" class="btn btn-default ${disabledStr}" data-toggle="modal" title="add attribute"><span class="glyphicon glyphicon-plus-sign"></span></a>
                       <a href="#addChildObjectModal${object.identifier}" role="button" class="btn btn-default" data-toggle="modal" title="add child object"><span class="glyphicon glyphicon-tags"></span></a>
                       <a href="#setParentModal${object.identifier}" role="button" class="btn btn-default" data-toggle="modal" title="add parent object"><span class="glyphicon glyphicon-tag"></span></a>
                       <a href="#setPropertiesModal${object.identifier}" role="button" class="btn btn-default" data-toggle="modal" title="Modify properties"><span class="glyphicon glyphicon-wrench"></span></a>
                       %endif
                       <a  class="btn btn-default" href="#infoModal${object.identifier}" role="button" data-toggle="modal" title="additional information"><span class="glyphicon glyphicon-question-sign"></span></a>
                       %if owner:
                       <a href="#" class="btn btn-danger" role="button"
                        onclick="if (confirm('Are you sure you want to delete?')) {
                                dialogCall('/events/event/objects/removeObject?eventID=${eventID}&objectID=${object.identifier}',
                                           'eventTabs${eventID}TabContent',
                                           '/events/event/objects/objects/${eventID}')}" title="delete"><i class="glyphicon glyphicon-remove-circle"></i></a>
                        <!--  dont remove this -->
			                <%call expr="baseForms.genericModalForm(modalID='addObjectAttributeModal{0}'.format(object.identifier),url='/events/event/attribute/modifyAttribute',refreshUrl='/events/event/objects/objects/{0}'.format(eventID),refreshContainer='eventTabs{0}TabContent'.format(eventID))">
			                  <input type="hidden" name="action" value="insert">
			                  <%call expr="modals.saveButtonModal(id='addObjectAttributeModal{0}'.format(object.identifier),title='Add attribute',contentUrl='/events/event/attribute/addAttribute/{0}/{1}'.format(eventID, object.identifier))"/>
			                </%call>
			           %endif
			                <%call expr="modals.genericDialogModal('infoModal{0}'.format(object.identifier), 'Details of {0} {1}'.format(object.definition.name,object.identifier), big=False)">
			                  <%call expr="forms.eventObjectForm(eventID,object, False,cbObjDefinitions)"/>
			                </%call>
			           %if owner:
			                <%call expr="baseForms.genericModalForm(modalID='addChildObjectModal{0}'.format(object.identifier),url='/events/event/objects/attachChildObject',refreshUrl='/events/event/objects/objects/{0}'.format(eventID),refreshContainer='eventTabs{0}TabContent'.format(eventID))">
			                    <%call expr="modals.saveButtonModal(id='addChildObjectModal{0}'.format(object.identifier),title='Add child object',contentUrl='/events/event/objects/addChildObject/{0}/{1}'.format(eventID, object.identifier))"/>
			                </%call>
			                <%call expr="baseForms.genericModalForm(modalID='setParentModal{0}'.format(object.identifier),url='/events/event/objects/modifyParentRelation',refreshUrl='/events/event/objects/objects/{0}'.format(eventID),refreshContainer='eventTabs{0}TabContent'.format(eventID))">
			                    <%call expr="modals.saveButtonModal(id='setParentModal{0}'.format(object.identifier),title='Set Object Parent',contentUrl='/events/event/objects/setObjectParent/{0}/{1}'.format(eventID, object.identifier))"/>
			                </%call>
			                <%call expr="baseForms.genericModalForm(modalID='setPropertiesModal{0}'.format(object.identifier),url='/events/event/bitValue/modifyObjectProperties',refreshUrl='/events/event/objects/objects/{0}'.format(eventID),refreshContainer='eventTabs{0}TabContent'.format(eventID))">
                                <%call expr="modals.saveButtonModal(id='setPropertiesModal{0}'.format(object.identifier),title='Set Object Properties',contentUrl='/events/event/bitValue/setObjectProperties/{0}/{1}'.format(eventID, object.identifier))"/>
                            </%call>
                       %endif
		                 <!--  dont remove this -->
		            %endif
                    </div>
                </div>
            </div>
        </div>
        <div id="${id}" class="panel-collapse collapse">
            <div class="panel-body">
                <div class="scrollBarPanel">
                    <script type="text/javascript">
                    $('#${id}').on('show.bs.collapse', function () {
                    	$('#menu${object.identifier}Link').parent().attr('class', 'active'); 
                    });
                    $('#${id}').on('hidden.bs.collapse', function () {
                    	$('#menu${object.identifier}Link').parent().attr('class', ''); 
                    });
                    </script>
                    <%call expr="pagination.pagination('attributesTable{0}'.format(object.identifier),paginator,hasSearch=False)"/>
                </div>

            </div>
        </div>
    </div>
    
  %endif
</%def>

<%def name="node(eventID, objectList, paginator,ident=1, showMenu=True, owner=False)">
    %if not objectList is None:
	<%
    spana = ident
    spanb = 12 - spana
	%>
            %for object in objectList:
	            <%
	            newPaginator = objectsHelper.copyObject(paginator)
	            values = list()
	            for item in object.attributes:
	               if (item.bitValue.isSharable and item.bitValue.isValidated) or owner:
	                 values.append(item)
	            newPaginator.list = values
	            #replace the %(objectID)s tag
	            newPaginator.options.reloadUrl = newPaginator.options.reloadUrl % dict(objectID=object.identifier)
	            for option in newPaginator.options.options:
	               option.url = option.url % dict(objectID=object.identifier)
	            %>
		        <%call expr="objectCollapseItem('collapseItem{0}'.format(object.identifier),'accordion{0}'.format(object.identifier),eventID, object, newPaginator, ident, showMenu, owner)"/>
	            <div class="row">
	            %if spana > 0:
	            <div class="col-xs-${spana} col-sm-${spana}">&nbsp;</div>
	            %endif
	            <div class="col-xs-${spanb} col-sm-${spanb}">
	               <%call expr="node(eventID, object.children, paginator,ident+1, showMenu, owner)"/>
	            </div>
	            </div>
            %endfor
    %endif
</%def>

<%def name="menuItem(objectList,owner,ident=0)">
%if not objectList is None:
  <%
   identString = 20 * ident
  %>
  %for object in objectList:
     %if (object.bitValue.isValidated and object.bitValue.isSharable) or owner:
     <li id="menu${object.identifier}LI" style="margin-left:${identString}px;"><a  id="menu${object.identifier}Link" href="#" onclick="activateMenuLi(this.id);showSelected('${object.identifier}')">${object.definition.name} - ${object.identifier}</a></li>
     <%call expr="menuItem(object.children,owner, ident+1)"/>
     %endif
  %endfor
%endif
</%def>
