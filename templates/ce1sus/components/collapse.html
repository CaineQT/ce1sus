<%namespace name="modals" file="/dagr/components/modals.html"/>
<%namespace name="base_forms" file="/dagr/components/forms.html"/> 
<%namespace name="forms" file="/ce1sus/components/forms.html"/> 
<%namespace name="objectsHelper" module="dagr.web.helpers.objects"/>
<%namespace name="messages_and_text" file="/dagr/components/messagesAndText.html"/>


<%def name="attribute_modal_form(modal_id, url, content_id, refresh_url=None, refresh_container=None)">
<form id="${modal_id}Form" name="${modal_id}FormName" method="POST" action="${url}" class="form-horizontal" enctype="multipart/form-data">
    ${caller.body()}
</form>
<script type="text/javascript">
$( document ).ready(function() {
    $("#${modal_id}Form").submit(function(event){
        <%
        if not (refresh_url is None and refresh_container is None):
            refresh = 'true'
        else:
            refresh = 'false'
        %>
        genericFormSubmit(this,event,'${modal_id}' ,'${content_id}', '${url}','${refresh}','${refresh_container}','${refresh_url}');
    });
});
</script>
</%def>

<%def name="object_collapse_item(id, parent_id, event_id, object, indent=0, show_menu=True, owner=False, user=None,show=False)">
<%
if show:
  show_js = 'true'
else:
  show_js = 'false'
%>

<%
allowed = owner or (user.default_group.identifier == object.creator_group.identifier and not object.bit_value.is_validated)
%>
% if (not object is None) and (object.bit_value.is_validated or allowed ):
<%
if object.bit_value.is_proposal and not object.bit_value.is_validated:
  header_bg = 'background-color: yellow;'
else:
  header_bg = ''
%>
        <div class="panel panel-default" >
        <div class="panel-heading" style="padding:5px;${header_bg}">
            <div class="row">
                <div class="col-xs-5 col-sm-5" style="height: 34px; line-height: 34px;">

                     <a class="accordion-toggle" data-toggle="collapse" data-parent="#${parent_id}" href="#${id}">
                     
                        ${object.definition.name} - ${object.identifier} 
                    </a>

                </div>
                <div class="col-xs-1 col-sm-1" style="height: 34px; line-height: 34px;">
                     %if not object.bit_value.is_shareable:
                        <span class="glyphicon glyphicon-lock" data-toggle="tooltip" data-placement="top" title="This object is not shared."></span>
                     %endif
                </div>
                <div class="col-xs-6 col-sm-6" style="text-align: right;">
                    <div class="btn-group">
                    <%
                   
                    if len(object.definition.attributes) == 0:
                      disabled_str = ' disabled" '
                    else:
                      disabled_str = '" data-toggle="modal"'
                    %> 
                    %if show_menu:
                       %if owner:
                         <a  onclick="inforUnpublished('addObjectAttributeModal${object.identifier}','${event_id}',${show_js});" href="#" role="button" class="btn btn-default ${disabled_str}" data-toggle="modal" title="add attribute"><span class="glyphicon glyphicon-plus-sign"></span></a>
                         <a onclick="inforUnpublished('addChildObjectModal${object.identifier}','${event_id}',${show_js});" href="#" role="button" class="btn btn-default" data-toggle="modal" title="add child object"><span class="glyphicon glyphicon-download"></span></a>
                         %if owner and object.bit_value.is_proposal and not object.bit_value.is_validated:
                         <a onclick="inforUnpublished('validateObjectModal${object.identifier}','${event_id}',${show_js});" href="#" role="button" class="btn btn-default" data-toggle="modal"><span class="glyphicon glyphicon-saved" title="Validate object"></span></a>
                         %endif
                       %else:
	                         <a href="#addObjectAttributeModal${object.identifier}" role="button" class="btn btn-default ${disabled_str}" data-toggle="modal" title="add attribute"><span class="glyphicon glyphicon-plus-sign"></span></a>
	-                        <a href="#addChildObjectModal${object.identifier}" role="button" class="btn btn-default" data-toggle="modal" title="add child object"><span class="glyphicon glyphicon-download"></span></a>
                       %endif
                       
                       %if allowed:
                       <a href="#setParentModal${object.identifier}" role="button" class="btn btn-default" data-toggle="modal" title="Modify object"><span class="glyphicon glyphicon-list"></span></a>
                       <a href="#setPropertiesModal${object.identifier}" role="button" class="btn btn-default" data-toggle="modal" title="Modify properties"><span class="glyphicon glyphicon-pencil"></span></a>
                       %endif
                       <a  class="btn btn-default" href="#infoModal${object.identifier}" role="button" data-toggle="modal" title="View details"><span class="glyphicon glyphicon-eye-open"></span></a>
                       %if allowed:
                       <a href="#" class="btn btn-danger" role="button"
                        onclick="if (confirm('Are you sure you want to delete?')) {
                                dialogCall('/events/event/objects/remove_object?event_id=${event_id}&object_id=${object.identifier}',
                                           'ObjectsStructured${event_id}',
                                           '/events/event/objects/objects/${event_id}')}"><span class="glyphicon glyphicon-remove-circle"  title="delete"></span></a>
                        <!--  dont remove this -->
                        %endif
                     </div>
                     </div>

			                <%call expr="attribute_modal_form(modal_id='addObjectAttributeModal{0}'.format(object.identifier),content_id='editBox_eventAttributeFromNoneHidden',url='/events/event/attribute/call_handler_post',refresh_url='/events/event/objects/objects/{0}'.format(event_id),refresh_container='ObjectsStructured{0}'.format(event_id))">
			                  <input type="hidden" name="action" value="insert">
			                  <%call expr="modals.save_button_modal(id='addObjectAttributeModal{0}'.format(object.identifier),title='Add attribute',content_url='/events/event/attribute/add_attribute/{0}/{1}'.format(event_id, object.identifier), big=True)"/>
			                </%call>
			           
			                <%call expr="modals.generic_dialog_modal('infoModal{0}'.format(object.identifier), 'Details of {0} {1}'.format(object.definition.name,object.identifier), big=False)">
			                  <%call expr="forms.eventObjectForm(event_id,object, False,obj_definitions)"/>
			                </%call>
			           %if allowed or owner:
			                <%call expr="base_forms.generic_modal_form(modal_id='addChildObjectModal{0}'.format(object.identifier),url='/events/event/objects/attach_child_object',refresh_url='/events/event/objects/objects/{0}'.format(event_id),refresh_container='ObjectsStructured{0}'.format(event_id))">
			                    <%call expr="modals.save_button_modal(id='addChildObjectModal{0}'.format(object.identifier),title='Add child object',content_url='/events/event/objects/add_child_object/{0}/{1}'.format(event_id, object.identifier))"/>
			                </%call>
			                <%call expr="base_forms.generic_modal_form(modal_id='setParentModal{0}'.format(object.identifier),url='/events/event/objects/modify_parent',refresh_url='/events/event/objects/objects/{0}'.format(event_id),refresh_container='ObjectsStructured{0}'.format(event_id))">
			                    <%call expr="modals.save_button_modal(id='setParentModal{0}'.format(object.identifier),title='Set Object Parent',content_url='/events/event/objects/set_parent/{0}/{1}'.format(event_id, object.identifier))"/>
			                </%call>
                      
                            %if owner and object.bit_value.is_proposal and not object.bit_value.is_validated:
                              <%call expr="base_forms.generic_modal_form(modal_id='validateObjectModal{0}'.format(object.identifier),url='/events/event/objects/validate_object',refresh_url='/events/event/objects/objects/{0}'.format(event_id),refresh_container='ObjectsStructured{0}'.format(event_id))">
                                  <%call expr="modals.save_button_modal(id='validateObjectModal{0}'.format(object.identifier),title='Validate Object',content_url='/events/event/objects/validate_object_modal/{0}/{1}'.format(event_id, object.identifier))"/>
                              </%call>
                            %endif
                            
			                <%call expr="base_forms.generic_modal_form(modal_id='setPropertiesModal{0}'.format(object.identifier),url='/events/event/bit_value/modify_object_properties',refresh_url='/events/event/objects/objects/{0}'.format(event_id),refresh_container='ObjectsStructured{0}'.format(event_id))">
                                <%call expr="modals.save_button_modal(id='setPropertiesModal{0}'.format(object.identifier),title='Set Object Properties',content_url='/events/event/bit_value/set_object_properties/{0}/{1}'.format(event_id, object.identifier))"/>
                            </%call>
                       %endif
		                 <!--  dont remove this --> 
		            %endif
                    

            </div>
        </div>
        <div id="${id}" class="panel-collapse collapse">
            <div class="panel-body" style="padding: 5px;">
                <div class="scrollBarPanel">
                    <script type="text/javascript">
                    $('#${id}').on('show.bs.collapse', function () {
                    	$('#menu${object.identifier}Link').parent().attr('class', 'active'); 
                    });
                    $('#${id}').on('hidden.bs.collapse', function () {
                    	$('#menu${object.identifier}Link').parent().attr('class', ''); 
                    });
                    </script>
                    <div>
                      <table class="table table-striped table-bordered table-hover table-condensed" id="objectsTable_${id}">
                      <thead>
                        <tr>
                          <th caria-controls="objectsTable_${id}" tabindex="0" role="columnheader" class="sorting">#</th>
                          <th caria-controls="objectsTable_${id}" tabindex="1" role="columnheader" class="sorting">S</th>
                          <th caria-controls="objectsTable_${id}" tabindex="2" role="columnheader" class="sorting">Type</th>
                          <th caria-controls="objectsTable_${id}" tabindex="2" role="columnheader" class="sorting">Value</th>
                          <th caria-controls="objectsTable_${id}" tabindex="3" role="columnheader" class="sorting">IOC</th>
                          <th caria-controls="objectsTable_${id}" tabindex="4" role="columnheader" class="sorting">Options</th>
                        </tr>
                      </thead>
                      <tbody>
                      %for attribute in object.attributes:
                        <%
                        if attribute.ioc == 1:
                          iocicon = '<span class="glyphicon glyphicon-screenshot"></span>'
                        else:
                            iocicon = ''
                        if attribute.bit_value.is_shareable:
                          shareicon = '<span class="glyphicon glyphicon-ok"></span>'
                        else:
                           shareicon = '<span class="glyphicon glyphicon-remove"></span>'
                        
                        attribute_owner = (user.default_group.identifier == attribute.creator_group_id)
                        if attribute.bit_value.is_proposal and not attribute.bit_value.is_validated:
                          tdstyle = 'style="background-color: yellow;"'
                        else:
                          tdstyle = ''
                        %>
                        
                        %if attribute.bit_value.is_validated_and_shared or owner or attribute_owner:
                        <tr >
                          <td ${tdstyle}><%call expr="messages_and_text.object_to_html(attribute.identifier, shorten_to=100,use_plain_text=False)"/></td>
                          <td style="text-align:center">${shareicon}</td>
                          <td><%call expr="messages_and_text.object_to_html(attribute.definition.name, shorten_to=100,use_plain_text=False)"/></td>
                          <td><%call expr="messages_and_text.object_to_html(attribute.gui_value, shorten_to=100,use_plain_text=False)"/></td>
                          <td style="text-align:center">${iocicon}</td>
                          <td style="width: 60px;">
                            %for option in attribute.definition.handler.get_ordered_view_options(event_id,object.identifier,attribute.identifier):
                                <%
                                show = option.show_always
                                attribtue_owner = (user.default_group.identifier == attribute.creator_group.identifier and not attribute.bit_value.is_validated)
                                if not show:
                                  if option.validation_option:
                                    show = owner and attribute.bit_value.is_proposal and not attribute.bit_value.is_validated
                                  elif option.owner_option and not option.attribute_owner_option:
                                    show = owner
                                  elif option.attribute_owner_option and not option.owner_option:
                                    show = attribtue_owner and not attribute.bit_value.is_validated 
                                  elif option.attribute_owner_option and option.owner_option:
                                    show = (attribtue_owner and not attribute.bit_value.is_validated) or owner
                                  else:
                                    show = False 
                                %>
                                %if show:
                                  %if option.class_name == 'ModalOption':
                                    <%call expr="modalDialog(option, event_id,'ObjectsStructured','/events/event/objects/objects/{0}/{1}'.format(event_id,object.identifier))"/>
                                  %elif option.class_name == 'YesNoDialogOption':
                                    <%call expr="yesnoDialog(option, event_id, 'ObjectsStructured','/events/event/objects/objects/{0}/{1}'.format(event_id,object.identifier))"/>
                                  %else:
                                    UdO
                                  %endif
                                %endif
                            %endfor
                          </td>
                        </tr>
                        %endif
                      %endfor
                      </tbody>
                      </table>
                      <script type="text/javascript">
                      $('#objectsTable_${id}').dataTable( {
                          "iDisplayLength": 10,
                          "aaSorting": [[ 0, "desc" ]],
                        });
                      </script>
                    </div>
                </div>
            </div>
        </div>
    </div>
  %endif
</%def>

<%def name="modalDialog(option, event_id, container_prefix, refresh_url)">

<% 
if option.refresh:
  refresh_str = 'true'
else:
  refresh_str = 'false'
post_url_str='null'
if option.post_url:
  post_url_str = "'"+ option.post_url + "'"
%>
<a href="#" onclick="showPaginatorModal('paginatorModalAttributeObjectsStruct','${option.title}','${option.content_url}',${post_url_str},${refresh_str},'${container_prefix}${event_id}','${refresh_url}');">
  <span class="${option.icon_name}" title="${option.description}"></span>
</a>

</%def>

<%def name="yesnoDialog(option, event_id, container_prefix, refresh_url)">
<% 
if option.refresh:
  refresh_str = 'true'
else:
  refresh_str = 'false'
post_url_str='null'
if option.post_url:
  post_url_str = "'"+ option.post_url + "'"
%>
<a href="#" role="button"
  onclick="if (confirm('${option.message}')) {
      dialogCall('${option.post_url}',
                 '${container_prefix}${event_id}',
                 '${refresh_url}')}" title="${option.description}">
   <span class="${option.icon_name}" title="${option.description}"></span>
</a>
</%def>


<%def name="node(event_id, object_list, ident=1, show_menu=True, owner=False, user=None,show=False)">
    %if not object_list is None:
	<%
    #spana = ident
    spana = 1
    spanb = 12 - spana
	%>
            %for object in object_list:
	            %if object.dbcode & 12 == 12 or allowed:
				        <%call expr="object_collapse_item('collapseItem{0}'.format(object.identifier),'accordion{0}'.format(object.identifier),event_id, object, ident, show_menu, owner, user, show)"/>
			            <div class="row">
			            %if spana > 0:
			            <div class="col-xs-${spana} col-sm-${spana}">&nbsp;</div>
			            %endif
			            <div class="col-xs-${spanb} col-sm-${spanb}">
			               <%call expr="node(event_id, object.children,ident+1, show_menu, owner, user)"/>
			            </div>
			            </div>
		           %endif
            %endfor
    %endif
    %if ident == 1:
    <form id="paginatorModalAttributeObjectsStructForm">
    <%call expr="modals.generic_modal(id='paginatorModalAttributeObjectsStruct',title='No Title',content_url=None)">
    </%call>
    </form>
    <script type="text/javascript">
      jQuery.fn.dataTableExt.oSort['string-case-asc']  = function(x,y) {
        return ((x < y) ? -1 : ((x > y) ?  1 : 0));
      };
       
      jQuery.fn.dataTableExt.oSort['string-case-desc'] = function(x,y) {
        return ((x < y) ?  1 : ((x > y) ? -1 : 0));
      };
    </script>
    %endif
</%def>

<%def name="menu_item(object_list,owner,ident=0)">
%if not object_list is None:
  <%
   ident_string = 10 * ident
  %>
  
	  %for object in object_list:
		  %if object.dbcode & 12 == 12 or allowed:
		     <li id="menu${object.identifier}LI" style="margin-left:${ident_string}px;"><a  id="menu${object.identifier}Link" href="#" onclick="activateMenuLi(this.id);showSelected('${object.identifier}')">${object.definition.name} - ${object.identifier}</a></li>
		     <%call expr="menu_item(object.children,owner, ident+1)"/>
		  %endif
	  %endfor
  
%endif
</%def>
