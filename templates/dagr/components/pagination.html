# -*- coding: utf-8 -*-

<%namespace name="messagesAndText" file="/dagr/components/messagesAndText.html"/>
<%namespace name="modals" file="/dagr/components/modals.html"/>
<%namespace name="forms" file="/dagr/components/forms.html"/>

<%def name="pagination(identifier, paginator,hasSearch=True, usePlainText=False)">
<% 
isModal=False
%>
    <!-- BEGIN pagination -->
    <div style="margin-bottom:35px">
      <table class="table table-striped table-bordered table-hover table-condensed" id="${identifier}">
      <thead>
        <tr>
          % for column in paginator.lables:
            % for key,value in column.iteritems():
                <%
                    tdOption=paginator.tdOptions.get(key,None)
                    if tdOption:
                        tdcss = tdOption.css
                    else:
                        tdcss = ''
                %>
                <th caria-controls="${identifier}" tabindex="0" role="columnheader" class="sorting" style="${tdcss}">${value}</th>
            %endfor
          %endfor
          %if paginator.options.isSet:
            <th caria-controls="${identifier}" tabindex="0" role="columnheader" class="sorting" style="width: 30px">Options</th>
          %endif
        </tr>
      </thead>
      <tbody>
        
           % for item in paginator.list:
<%
trStyle = ''
if paginator.trcolor:
   trcolor = 'background-color:{0};'.format(paginator.trcolor)
#get attriubute condition value
if paginator.conditionAttribute:
	condVal = getattr(item, paginator.conditionAttribute)
	if condVal and condVal == 1:
	    trStyle = 'style="{0}"'.format(trcolor)
	else:
	    trStyle = ''
%>
           %if paginator.trlink:
           <tr ${trStyle} onclick="${paginator.trlink.replace('identifier','{0}'.format(item.identifier))}">
           %else:
           <tr ${trStyle}>
           %endif
             % for column in paginator.lables:
               % for key in column.iterkeys():
    <%
    if hasattr(item,key):
      value = getattr(item,key)
      if hasattr(value,'color'):
        style = 'style="background-color: {hex}"'.format(hex=getattr(value,'color'))
        value = getattr(value,'text')
      else:
        style = ''
    else:
      
      if '.' in key:
        keys = key.split('.')
       
        if hasattr(item,keys[0]):
          subItem = getattr(item,keys[0])
          if hasattr(subItem,keys[1]):
            value = getattr(subItem,keys[1])
    
      else:
        value ='NotSet'
      
      style = ''
    
    
    
    if hasattr(item,'identifier'):
      primaryKey = getattr(item,'identifier')
    else:
      primaryKey = 0
      
    tdOption=paginator.tdOptions.get(key,None)
    if tdOption:
      useRawHTML = tdOption.useRawHTML
    else:
      useRawHTML = usePlainText
    %>                
             <td ${style}><%call expr="messagesAndText.objectToHTML(value, shortenTo=paginator.maxColumnLength,usePlainText=useRawHTML)"/></td>
           %endfor
    
             %endfor
             %if paginator.options.isSet:
               <td style="width: 60px;">
                  % for option in paginator.options.options:
                    %if option.mode =='DIALOG':
                        <a href="#" onclick="if (confirm('${option.message}')) {
                        $.get('${option.url}${primaryKey}', function(data) {
                        	if (data.match(/^<!--OK--/gi)) {
                        		%if option.refresh:
                                    loadContent('${paginator.options.contentid}','${paginator.options.reloadUrl}');
                                %endif
                        	} else {
                        		alert('An unexpected error occured.');
                        	}
                        	
                        }).fail(function() { alert('Could not perform action: '); });
                        
                       
                        }"><i class="${option.icon}" title="${option.title}"></i></a>
                    %elif option.mode =='MODAL':
                        <% 
                        isModal=True
                        %>
                        <a href="#" onclick="showPaginatorModal('paginatorModal${identifier}','${option.modalTitle}','${option.url}/${primaryKey}','${option.postUrl}','${option.refresh}','${paginator.options.contentid}','${paginator.options.reloadUrl}');">
        
                        <span class="${option.icon}" title="${option.title}"></span></a>
                    %elif option.mode == 'LINK':
                        <a href="${option.url}/${primaryKey}"><i class="${option.icon}" title="${option.title}"></i></a>
                    %elif option.mode == 'CONTENT':
                        <% 
                        isContent=True
                        %>
                        <a href="#" onclick="loadContent('${paginator.options.contentid}','${option.url}/${primaryKey}');">
                        %if option.refresh:
                            loadContent('${paginator.options.contentid}','${paginator.options.reloadUrl}');
                        %endif  
                        <span class="${option.icon}" title="${option.title}"></span></a>
                    %elif option.mode == 'NEWTAB':
                        <%
                        enabledStr = 'false'
                        if option.reload:
                          enabledStr = 'true'
                        %>
                        <a href="#" onclick="loadNewTab('${primaryKey}','${paginator.options.contentid}','${option.url}/${primaryKey}',${enabledStr}, '${option.tabTitle} #${primaryKey}' );">
                        <span class="${option.icon}" title="${option.title}"></span></a>
                    %elif option.mode == 'TAB':
                        <a href="#" onclick="loadTabFromPaginator('${primaryKey}','${paginator.options.contentid}','${option.url}/${primaryKey}','${option.tabid}');">
                        <span class="${option.icon}" title="${option.title}"></span></a>
                    %endif
                    
                    
                    
                  %endfor
               </td>
             %endif
             </tr>
           %endfor
    
      </tbody>
      </table>
      
    </div>
    <script type="text/javascript">
    jQuery.fn.dataTableExt.oSort['string-case-asc']  = function(x,y) {
        return ((x < y) ? -1 : ((x > y) ?  1 : 0));
    };
     
    jQuery.fn.dataTableExt.oSort['string-case-desc'] = function(x,y) {
        return ((x < y) ?  1 : ((x > y) ? -1 : 0));
    };
    
    $(document).ready(function() {
        $('#${identifier}').dataTable( {
          "iDisplayLength": ${paginator.itemsPerPage},
          %if not hasSearch:
          "sDom": '<"top"i>rt<"bottom"flp><"clear">',
          "bAutoWidth" :false,
          %endif
          "aaSorting": [[ ${paginator.sortColunmID}, "${paginator.sortOrder}" ]],
         });
    } );

    </script>

    <!-- END pagination -->
% if isModal:
<form id="paginatorModal${identifier}Form">
    <%call expr="modals.genericModal(id='paginatorModal{0}'.format(identifier),title='No Title',contentUrl=None)">
    </%call>
</form>
%endif

</%def>