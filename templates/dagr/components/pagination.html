# -*- coding: utf-8 -*-

<%namespace name="messagesAndText" file="/dagr/components/messagesAndText.html"/>
<%namespace name="modals" file="/dagr/components/modals.html"/>
<%namespace name="forms" file="/dagr/components/forms.html"/>

<%def name="pagination(identifier, paginator,has_search=True, use_plain_text=False)">
<% 
is_modal=False
%>
    <!-- BEGIN pagination -->
    <div style="margin-bottom:35px">
      <table class="table table-striped table-bordered table-hover table-condensed" id="${identifier}">
      <thead>
        <tr>
          % for column in paginator.lables:
            % for key,value in column.iteritems():
                <%
                    td_option=paginator.td_options.get(key,None)
                    if td_option:
                        tdcss = td_option.css
                    else:
                        tdcss = ''
                %>
                <th caria-controls="${identifier}" tabindex="0" role="columnheader" class="sorting" style="${tdcss}">${value}</th>
            %endfor
          %endfor
          %if paginator.options.is_set:
            <th caria-controls="${identifier}" tabindex="0" role="columnheader" class="sorting" style="width: 30px">Options</th>
          %endif
        </tr>
      </thead>
      <tbody>
        
           % for item in paginator.list:
			<%
			tr_style = ''
			if paginator.trcolor:
			   trcolor = 'background-color:{0};'.format(paginator.trcolor)
			#get attriubute condition value
			if paginator.condition_attribute:
				condVal = getattr(item, paginator.condition_attribute)
				if condVal and condVal == 1:
				    tr_style = 'style="{0}"'.format(trcolor)
				else:
				    tr_style = ''
			%>
           %if paginator.trlink:
           <tr ${tr_style} onclick="${paginator.trlink.replace('identifier','{0}'.format(item.identifier))}">
           %else:
           <tr ${tr_style}>
           %endif
             % for column in paginator.lables:
               % for key in column.iterkeys():
    <%
    if hasattr(item,key):
      value = getattr(item,key)
      if hasattr(value,'color'):
        style = 'style="background-color: {hex}"'.format(hex=getattr(value,'color'))
        value = getattr(value,'text')
      else:
        style = ''
    else:
      
      if '.' in key:
        keys = key.split('.')
       
        if hasattr(item,keys[0]):
          subItem = getattr(item,keys[0])
          if hasattr(subItem,keys[1]):
            value = getattr(subItem,keys[1])
    
      else:
        value ='NotSet'
      
      style = ''
    
    
    
    if hasattr(item,'identifier'):
      primary_key = getattr(item,'identifier')
    else:
      primary_key = 0
      
    td_option=paginator.td_options.get(key,None)
    if td_option:
      user_raw_html = td_option.use_raw_html
    else:
      user_raw_html = use_plain_text
    %>                
             <td ${style}><%call expr="messagesAndText.object_to_html(value, shorten_to=paginator.max_column_length,use_plain_text=user_raw_html)"/></td>
           %endfor
    
             %endfor
             %if paginator.options.is_set:
               <td style="width: 60px;">
                  % for option in paginator.options.options:
                    %if option.mode =='DIALOG':
                        <a href="#" onclick="if (confirm('${option.message}')) {
                        $.get('${option.url}${primary_key}', function(data) {
                        	if (data.match(/^<!--OK--/gi)) {
                        		%if option.refresh:
                                    loadContent('${paginator.options.contentid}','${paginator.options.reload_url}');
                                %endif
                        	} else {
                        		alert('An unexpected error occured.');
                        	}
                        	
                        }).fail(function() { alert('Could not perform action: '); });
                        
                       
                        }"><i class="${option.icon}" title="${option.title}"></i></a>
                    %elif option.mode =='MODAL':
                        <% 
                        is_modal=True
                        %>
                        <a href="#" onclick="showPaginatorModal('paginatorModal${identifier}','${option.modal_title}','${option.url}/${primary_key}','${option.post_url}','${option.refresh}','${paginator.options.contentid}','${paginator.options.reload_url}');">
        
                        <span class="${option.icon}" title="${option.title}"></span></a>
                    %elif option.mode == 'LINK':
                        <a href="${option.url}/${primary_key}"><i class="${option.icon}" title="${option.title}"></i></a>
                    %elif option.mode == 'CONTENT':
                        <% 
                        isContent=True
                        %>
                        <a href="#" onclick="loadContent('${paginator.options.contentid}','${option.url}/${primary_key}');">
                        %if option.refresh:
                            loadContent('${paginator.options.contentid}','${paginator.options.reload_url}');
                        %endif  
                        <span class="${option.icon}" title="${option.title}"></span></a>
                    %elif option.mode == 'NEWTAB':
                        <%
                        enabledStr = 'false'
                        if option.reload:
                          enabledStr = 'true'
                        %>
                        <a href="#" onclick="loadNewTab('${primary_key}','${paginator.options.contentid}','${option.url}/${primary_key}',${enabledStr}, '${option.tab_title} #${primary_key}' );">
                        <span class="${option.icon}" title="${option.title}"></span></a>
                    %elif option.mode == 'TAB':
                        <a href="#" onclick="loadTabFromPaginator('${primary_key}','${paginator.options.contentid}','${option.url}/${primary_key}','${option.tabid}');">
                        <span class="${option.icon}" title="${option.title}"></span></a>
                    %endif
                    
                    
                    
                  %endfor
               </td>
             %endif
             </tr>
           %endfor
    
      </tbody>
      </table>
      
    </div>
    <script type="text/javascript">
    jQuery.fn.dataTableExt.oSort['string-case-asc']  = function(x,y) {
        return ((x < y) ? -1 : ((x > y) ?  1 : 0));
    };
     
    jQuery.fn.dataTableExt.oSort['string-case-desc'] = function(x,y) {
        return ((x < y) ?  1 : ((x > y) ? -1 : 0));
    };
    
    $(document).ready(function() {
        $('#${identifier}').dataTable( {
          "iDisplayLength": ${paginator.items_per_page},
          %if not has_search:
          "sDom": '<"top"i>rt<"bottom"flp><"clear">',
          "bAutoWidth" :false,
          %endif
          "aaSorting": [[ ${paginator.sort_colunm_id}, "${paginator.sort_order}" ]],
         });
    } );

    </script>

    <!-- END pagination -->
% if is_modal:
<form id="paginatorModal${identifier}Form">
    <%call expr="modals.generic_modal(id='paginatorModal{0}'.format(identifier),title='No Title',content_url=None)">
    </%call>
</form>
%endif

</%def>